<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - DesignHub</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), 
                  url('https://images.unsplash.com/photo-1441986300917-64674bd600d8?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body class="text-white min-h-screen">
  <!-- Navbar -->
  <nav class="glass-effect flex justify-between items-center p-6 fixed w-full z-50">
    <div class="flex items-center space-x-2">
      <i class="fas fa-palette text-3xl text-purple-400"></i>
      <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">DesignHub</h1>
    </div>
    <div class="flex items-center space-x-6">
      <a href="/content" class="hover:text-purple-300 transition-colors duration-300">
        <i class="fas fa-shopping-bag mr-2"></i>Shop
      </a>
      <a href="/cart" class="hover:text-purple-300 transition-colors duration-300 relative">
        <i class="fas fa-shopping-cart mr-2"></i>Cart
        <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
      </a>
      <a href="/logout" class="hover:text-purple-300 transition-colors duration-300">
        <i class="fas fa-sign-out-alt mr-2"></i>Logout
      </a>
    </div>
  </nav>

  <div class="pt-24 pb-8 px-6">
    <div class="max-w-7xl mx-auto">
      <!-- Welcome Section -->
      <div class="glass-effect p-8 rounded-2xl mb-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
              <i class="fas fa-user-circle mr-3"></i>Welcome back, <%= user.name %>!
            </h1>
            <p class="text-xl text-gray-300">Here's what's happening with your orders and account</p>
          </div>
          <div class="text-right">
            <p class="text-sm text-gray-400">Member since</p>
            <p class="text-lg font-semibold"><%= new Date(user.createdAt).toLocaleDateString() %></p>
          </div>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="stat-card p-6 rounded-2xl text-center">
          <div class="w-16 h-16 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-shopping-bag text-2xl text-white"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-800"><%= stats.totalOrders %></h3>
          <p class="text-gray-600">Total Orders</p>
        </div>

        <div class="stat-card p-6 rounded-2xl text-center">
          <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-clock text-2xl text-white"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-800"><%= stats.pendingOrders %></h3>
          <p class="text-gray-600">Pending Orders</p>
        </div>

        <div class="stat-card p-6 rounded-2xl text-center">
          <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-check-circle text-2xl text-white"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-800"><%= stats.deliveredOrders %></h3>
          <p class="text-gray-600">Delivered</p>
        </div>

        <div class="stat-card p-6 rounded-2xl text-center">
          <div class="w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-rupee-sign text-2xl text-white"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-800">₹<%= stats.totalSpent.toFixed(2) %></h3>
          <p class="text-gray-600">Total Spent</p>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="glass-effect p-6 rounded-2xl mb-8">
        <h2 class="text-2xl font-bold mb-6 text-purple-300">
          <i class="fas fa-bolt mr-2"></i>Quick Actions
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <a href="/content" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 p-4 rounded-lg text-center transition-all duration-300 transform hover:scale-105">
            <i class="fas fa-shopping-bag text-2xl mb-2"></i>
            <p class="font-semibold">Continue Shopping</p>
          </a>
          <a href="/cart" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 p-4 rounded-lg text-center transition-all duration-300 transform hover:scale-105">
            <i class="fas fa-shopping-cart text-2xl mb-2"></i>
            <p class="font-semibold">View Cart</p>
          </a>
          <a href="#orders" class="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 p-4 rounded-lg text-center transition-all duration-300 transform hover:scale-105">
            <i class="fas fa-list text-2xl mb-2"></i>
            <p class="font-semibold">My Orders</p>
          </a>
        </div>
      </div>

      <!-- Recent Orders -->
      <div class="glass-effect p-6 rounded-2xl mb-8" id="orders">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-purple-300">
            <i class="fas fa-clock mr-2"></i>Recent Orders
          </h2>
          <a href="/orders" class="text-purple-300 hover:text-purple-200 transition-colors duration-300">
            View All <i class="fas fa-arrow-right ml-1"></i>
          </a>
        </div>

        <% if (recentOrders.length === 0) { %>
          <div class="text-center py-12">
            <i class="fas fa-shopping-bag text-6xl text-gray-400 mb-4"></i>
            <h3 class="text-2xl font-bold mb-2">No orders yet</h3>
            <p class="text-gray-300 mb-6">Start shopping to see your orders here!</p>
            <a href="/content" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 px-8 py-3 text-white rounded-full font-semibold transition-all duration-300 transform hover:scale-105">
              <i class="fas fa-shopping-bag mr-2"></i>Start Shopping
            </a>
          </div>
        <% } else { %>
          <div class="space-y-4">
            <% recentOrders.forEach(order => { %>
              <div class="bg-white bg-opacity-10 rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-4">
                    <img src="<%= order.productId.image %>" alt="<%= order.productId.name %>" class="w-16 h-16 object-cover rounded-lg">
                    <div>
                      <h3 class="font-semibold text-lg"><%= order.productId.name %></h3>
                      <p class="text-gray-300 text-sm">Quantity: <%= order.quantity %></p>
                      <p class="text-purple-300 font-semibold">₹<%= order.totalPrice.toFixed(2) %></p>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="flex items-center space-x-2 mb-2">
                      <span class="px-3 py-1 rounded-full text-sm font-semibold
                        <%= order.status === 'pending' ? 'bg-yellow-500 text-yellow-900' : '' %>
                        <%= order.status === 'confirmed' ? 'bg-blue-500 text-blue-900' : '' %>
                        <%= order.status === 'shipped' ? 'bg-purple-500 text-purple-900' : '' %>
                        <%= order.status === 'delivered' ? 'bg-green-500 text-green-900' : '' %>
                        <%= order.status === 'cancelled' ? 'bg-red-500 text-red-900' : '' %>">
                        <%= order.status.charAt(0).toUpperCase() + order.status.slice(1) %>
                      </span>
                      <span class="px-3 py-1 rounded-full text-sm font-semibold
                        <%= order.paymentStatus === 'pending' ? 'bg-yellow-500 text-yellow-900' : '' %>
                        <%= order.paymentStatus === 'completed' ? 'bg-green-500 text-green-900' : '' %>
                        <%= order.paymentStatus === 'failed' ? 'bg-red-500 text-red-900' : '' %>">
                        <%= order.paymentStatus.charAt(0).toUpperCase() + order.paymentStatus.slice(1) %>
                      </span>
                    </div>
                    <p class="text-sm text-gray-300">Ordered: <%= new Date(order.orderedAt).toLocaleDateString() %></p>
                    <% if (order.trackingNumber) { %>
                      <p class="text-sm text-purple-300">Tracking: <%= order.trackingNumber %></p>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } %>
      </div>

      <!-- Custom Requests Section -->
      <div class="glass-effect p-6 rounded-2xl mb-8" id="custom-requests">
        <h2 class="text-2xl font-bold text-purple-300 mb-6">
          <i class="fas fa-cogs mr-2"></i>My Custom Requests
        </h2>
        <% if (!customRequests || customRequests.length === 0) { %>
          <div class="text-center py-8">
            <i class="fas fa-cogs text-5xl text-gray-400 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">No custom requests yet</h3>
            <p class="text-gray-300">Submit a custom request from a designer's store page!</p>
          </div>
        <% } else { %>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-purple-100 rounded-2xl shadow-lg text-xs md:text-sm">
              <thead class="bg-gradient-to-r from-purple-100 to-pink-100">
                <tr>
                  <th class="py-2 px-2 md:py-3 md:px-4 border-b font-semibold text-gray-700">Designer</th>
                  <th class="py-2 px-2 md:py-3 md:px-4 border-b font-semibold text-gray-700">Description</th>
                  <th class="py-2 px-2 md:py-3 md:px-4 border-b font-semibold text-gray-700">Status</th>
                  <th class="py-2 px-2 md:py-3 md:px-4 border-b font-semibold text-gray-700">Designer Price</th>
                  <th class="py-2 px-2 md:py-3 md:px-4 border-b font-semibold text-gray-700">User Action</th>
                  <th class="py-2 px-2 md:py-3 md:px-4 border-b font-semibold text-gray-700">Address</th>
                  <th class="py-2 px-2 md:py-3 md:px-4 border-b font-semibold text-gray-700">Requested At</th>
                </tr>
              </thead>
              <tbody>
                <% customRequests.forEach(function(request, idx) { %>
                  <tr class="<%= idx % 2 === 0 ? 'bg-white' : 'bg-purple-50' %>">
                    <td class="py-2 px-2 md:py-3 md:px-4 border-b" style="color: black;"><%= request.designerId && request.designerId.storeName ? request.designerId.storeName : 'Designer' %></td>
                    <td class="py-2 px-2 md:py-3 md:px-4 border-b" style="color:black;"><%= request.description %></td>
                    <td class="py-2 px-2 md:py-3 md:px-4 border-b" style="color:black;">
                      <% if (request.status === 'pending') { %>
                        <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-bold">Pending</span>
                      <% } else if (request.status === 'accepted') { %>
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">Accepted</span>
                      <% } else if (request.status === 'rejected') { %>
                        <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold">Rejected</span>
                      <% } else if (request.status === 'completed') { %>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold">Completed</span>
                      <% } %>
                    </td>
                    <td class="py-2 px-2 md:py-3 md:px-4 border-b" style="color:black;">
                      <% if (request.status === 'accepted' && request.designerPrice) { %>
                        <span class="text-green-700 font-bold" style="color:black;">₹<%= request.designerPrice %></span>
                      <% } else { %>
                        -
                      <% } %>
                    </td>
                    <td class="py-2 px-2 md:py-3 md:px-4 border-b">
                      <% if (request.status === 'accepted' && !request.userAccepted) { %>
                        <form action="/custom-request/<%= request._id %>/user-action" method="POST" class="inline">
                          <input type="hidden" name="action" value="accept">
                          <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs font-semibold mr-1">Accept</button>
                        </form>
                        <form action="/custom-request/<%= request._id %>/user-action" method="POST" class="inline">
                          <input type="hidden" name="action" value="reject">
                          <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-semibold">Reject</button>
                        </form>
                      <% } else if (request.status === 'accepted' && request.userAccepted) { %>
                        <span class="bg-green-200 text-green-800 px-3 py-1 rounded-full text-xs font-bold">You Accepted</span>
                      <% } else { %>
                        -
                      <% } %>
                      <button class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-xs font-semibold mt-1" onclick="openChatModal('<%= request.designerId ? request.designerId._id : '' %>', '<%= request._id %>')">Chat with Designer</button>
                    </td>
                    <td class="py-2 px-2 md:py-3 md:px-4 border-b" style="color:black;"><%= request.address %></td>
                    <td class="py-2 px-2 md:py-3 md:px-4 border-b" style="color:black;"><%= request.createdAt ? new Date(request.createdAt).toLocaleDateString() : '-' %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>

      <!-- Account Information -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Profile Information -->
        <div class="glass-effect p-6 rounded-2xl">
          <h2 class="text-2xl font-bold mb-6 text-purple-300">
            <i class="fas fa-user mr-2"></i>Profile Information
          </h2>
          <div class="space-y-4">
            <div class="flex justify-between items-center p-3 bg-white bg-opacity-10 rounded-lg">
              <span class="font-semibold">Name:</span>
              <span><%= user.name %></span>
            </div>
            <div class="flex justify-between items-center p-3 bg-white bg-opacity-10 rounded-lg">
              <span class="font-semibold">Email:</span>
              <span><%= user.email %></span>
            </div>
            <div class="flex justify-between items-center p-3 bg-white bg-opacity-10 rounded-lg">
              <span class="font-semibold">Member Since:</span>
              <span><%= new Date(user.createdAt).toLocaleDateString() %></span>
            </div>
            <div class="flex justify-between items-center p-3 bg-white bg-opacity-10 rounded-lg">
              <span class="font-semibold">Total Orders:</span>
              <span><%= stats.totalOrders %></span>
            </div>
          </div>
          <button class="w-full mt-6 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 py-3 text-white rounded-lg font-semibold transition-all duration-300">
            <i class="fas fa-edit mr-2"></i>Edit Profile
          </button>
        </div>

        <!-- Shopping Preferences -->
        <div class="glass-effect p-6 rounded-2xl">
          <h2 class="text-2xl font-bold mb-6 text-purple-300">
            <i class="fas fa-heart mr-2"></i>Shopping Preferences
          </h2>
          <div class="space-y-4">
            <div class="flex justify-between items-center p-3 bg-white bg-opacity-10 rounded-lg">
              <span class="font-semibold">Favorite Categories:</span>
              <span class="text-purple-300">Not set</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-white bg-opacity-10 rounded-lg">
              <span class="font-semibold">Preferred Payment:</span>
              <span class="text-purple-300">Online</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-white bg-opacity-10 rounded-lg">
              <span class="font-semibold">Newsletter:</span>
              <span class="text-green-400">Subscribed</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-white bg-opacity-10 rounded-lg">
              <span class="font-semibold">Notifications:</span>
              <span class="text-green-400">Enabled</span>
            </div>
          </div>
          <button class="w-full mt-6 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 py-3 text-white rounded-lg font-semibold transition-all duration-300">
            <i class="fas fa-cog mr-2"></i>Manage Preferences
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Modal Placeholder -->
  <div id="chatModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-4 relative">
      <button onclick="closeChatModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700">&times;</button>
      <h3 class="text-lg font-bold mb-2">Chat with Designer</h3>
      <div id="chatMessages" class="h-64 overflow-y-auto border rounded p-2 mb-2 bg-gray-50"></div>
      <form id="chatForm" class="flex gap-2">
        <input type="text" id="chatInput" class="flex-1 border rounded px-2 py-1" placeholder="Type your message..." required />
        <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded">Send</button>
      </form>
    </div>
  </div>
  <!-- Add Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const USER_ID = '<%= user._id %>';
    let currentDesignerId = null;
    let currentRequestId = null;
    let socket = io();

    function openChatModal(designerId, requestId) {
      document.getElementById('chatModal').classList.remove('hidden');
      currentDesignerId = designerId;
      currentRequestId = requestId;
      document.getElementById('chatMessages').innerHTML = '';
      // Join a room for this request
      socket.emit('joinRoom', { requestId: currentRequestId });
      // TODO: Optionally load previous messages via AJAX
    }
    function closeChatModal() {
      document.getElementById('chatModal').classList.add('hidden');
      document.getElementById('chatMessages').innerHTML = '';
      // Leave the room
      if (currentRequestId) {
        socket.emit('leaveRoom', { requestId: currentRequestId });
      }
      currentDesignerId = null;
      currentRequestId = null;
    }
    document.getElementById('chatForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const message = document.getElementById('chatInput').value.trim();
      if (!message || !currentRequestId) return;
      socket.emit('chatMessage', {
        requestId: currentRequestId,
        sender: 'user',
        senderId: USER_ID,
        message
      });
      document.getElementById('chatInput').value = '';
    });
    // Listen for previous messages
    socket.on('previousMessages', function(messages) {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      messages.forEach(function(data) {
        const msgDiv = document.createElement('div');
        msgDiv.className = data.senderType === 'user' && data.senderId === USER_ID ? 'text-right mb-1' : 'text-left mb-1';
        msgDiv.innerHTML = `<span class='inline-block px-2 py-1 rounded bg-purple-200 text-sm'>${data.message}</span>`;
        chatMessages.appendChild(msgDiv);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
    // Listen for incoming messages
    socket.on('chatMessage', function(data) {
      if (data.requestId !== currentRequestId) return;
      const chatMessages = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = data.senderId == USER_ID ? 'text-right mb-1' : 'text-left mb-1';
      msgDiv.innerHTML = `<span class='inline-block px-2 py-1 rounded bg-purple-200 text-sm'>${data.message}</span>`;
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  </script>
  <script>
    // Load cart count on page load
    window.addEventListener('load', function() {
      fetch('/cart')
        .then(response => response.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const cartItems = doc.querySelectorAll('[id^="cart-item-"]');
          const cartCount = document.getElementById('cart-count');
          if (cartItems.length > 0) {
            cartCount.textContent = cartItems.length;
            cartCount.classList.remove('hidden');
          }
        })
        .catch(error => {
          console.error('Error loading cart count:', error);
        });
    });
  </script>
</body>
</html> 